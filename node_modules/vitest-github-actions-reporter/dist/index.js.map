{"version":3,"sources":["../src/index.ts","../src/stacktrace/parse.ts","../src/stacktrace/stringify.ts"],"sourcesContent":["import type {\n  ErrorWithDiff,\n  File,\n  ParsedStack,\n  Reporter,\n  Task,\n  Vitest\n} from 'vitest'\nimport {\n  startGroup,\n  endGroup,\n  error,\n  type AnnotationProperties\n} from '@actions/core'\nimport { parseStacktrace } from './stacktrace/parse'\nimport { stringifyStacktrace } from './stacktrace/stringify'\n\nexport type GitHubActionsReporterOptions = {\n  /**\n   * @default true\n   */\n  trimRepositoryPrefix?: boolean\n  /**\n   * @default false\n   */\n  hideStackTrace?: boolean\n}\n\nexport default class GitHubActionsReporter implements Reporter {\n  ctx!: Vitest\n  options: Required<GitHubActionsReporterOptions>\n\n  constructor({\n    trimRepositoryPrefix = true,\n    hideStackTrace = false\n  }: GitHubActionsReporterOptions = {}) {\n    this.options = {\n      trimRepositoryPrefix,\n      hideStackTrace\n    }\n  }\n\n  onInit(ctx: Vitest) {\n    this.ctx = ctx\n  }\n\n  async onFinished(files?: File[]) {\n    if (!files) return\n\n    startGroup('Vitest Annotations')\n    this.reportFiles(files)\n    endGroup()\n  }\n\n  private reportFiles(files: File[]) {\n    for (const file of files) {\n      this.reportTaskErrors(file.filepath, file)\n      this.reportTasks(file.filepath, file.tasks)\n    }\n  }\n\n  private reportTasks(filename: string, tasks: Task[]) {\n    for (const task of tasks) {\n      if (task.type === 'suite') {\n        this.reportTaskErrors(filename, task)\n\n        this.reportTasks(filename, task.tasks)\n      } else if (task.type === 'test') {\n        this.reportTaskErrors(filename, task)\n      } else if (task.type === 'custom') {\n        // TODO: benchmark?\n      } else {\n        checkNever(task)\n      }\n    }\n  }\n\n  private reportTaskErrors(filename: string, task: Task) {\n    for (const err of task.result?.errors ?? []) {\n      this.reportTaskError(task.type, filename, err)\n    }\n  }\n\n  private reportTaskError(\n    taskType: 'suite' | 'test' | 'custom',\n    filename: string,\n    err: ErrorWithDiff\n  ) {\n    const stackTrace = this.parseStacktrace(err.stackStr)\n    const position = this.getPositionFromError(filename, stackTrace)\n    const message = this.createMessage(stackTrace)\n\n    error(message, {\n      ...position,\n      title: this.getErrorTitle(\n        err,\n        `Failed ${taskType[0]!.toUpperCase()}${taskType.slice(1)}`\n      )\n    })\n  }\n\n  private parseStacktrace(stacktraceStr: string | undefined) {\n    if (!stacktraceStr) return undefined\n    return parseStacktrace(stacktraceStr)\n  }\n\n  private createMessage(stacktrace: ParsedStack[] | undefined) {\n    if (this.options.hideStackTrace) return '.'\n\n    if (!stacktrace) return 'No stacktrace'\n    return stringifyStacktrace(stacktrace, this.options.trimRepositoryPrefix)\n  }\n\n  private getPositionFromError(\n    filename: string,\n    stacktrace?: ParsedStack[]\n  ): AnnotationProperties {\n    if (!stacktrace || !stacktrace[0]) {\n      return { file: filename }\n    }\n\n    const { file, line, column } = stacktrace[0]\n    return {\n      file: file,\n      startLine: line,\n      startColumn: column\n    }\n  }\n\n  private getErrorTitle(error: ErrorWithDiff | undefined, fallback: string) {\n    return `${error?.name ?? 'Error'}: ${error?.message ?? fallback}`\n  }\n}\n\n// eslint-disable-next-line @typescript-eslint/no-empty-function, @typescript-eslint/no-unused-vars\nfunction checkNever(_: never) {}\n","/*!\n  https://github.com/vitest-dev/vitest/blob/f1cdfb6960a1eb39345f973529bc1e72ab4090b4/packages/vitest/src/utils/source-map.ts#L59-L115\n  MIT License\n  Copyright (c) 2021-Present Anthony Fu <https://github.com/antfu>\n  Copyright (c) 2021-Present Matias Capeletto <https://github.com/patak-dev>\n  https://github.com/vitest-dev/vitest/blob/main/LICENSE\n*/\n\nimport type { ParsedStack } from 'vitest'\nimport path from 'node:path'\n\nconst stackIgnorePatterns = [\n  'node:internal',\n  /\\/packages\\/\\w+\\/dist\\//,\n  /\\/@vitest\\/\\w+\\/dist\\//,\n  '/vitest/dist/',\n  '/vitest/src/',\n  '/vite-node/dist/',\n  '/vite-node/src/',\n  '/node_modules/chai/',\n  '/node_modules/tinypool/',\n  '/node_modules/tinyspy/'\n]\n\nconst slash = (str: string) => str.replace(/\\\\/g, '/')\nconst resolve = (str: string) => slash(path.resolve(str))\n\nfunction notNullish<T>(v: T | null | undefined): v is NonNullable<T> {\n  return v != null\n}\n\nfunction extractLocation(urlLike: string) {\n  // Fail-fast but return locations like \"(native)\"\n  if (!urlLike.includes(':')) return [urlLike]\n\n  const regExp = /(.+?)(?::(\\d+))?(?::(\\d+))?$/\n  const parts = regExp.exec(urlLike.replace(/[()]/g, ''))\n  if (!parts) return [urlLike]\n  return [parts[1], parts[2] || undefined, parts[3] || undefined]\n}\n\n// Based on https://github.com/stacktracejs/error-stack-parser\n// Credit to stacktracejs\nexport function parseSingleStack(raw: string): ParsedStack | null {\n  let line = raw.trim()\n\n  if (line.includes('(eval '))\n    line = line\n      .replace(/eval code/g, 'eval')\n      .replace(/(\\(eval at [^()]*)|(,.*$)/g, '')\n\n  let sanitizedLine = line\n    .replace(/^\\s+/, '')\n    .replace(/\\(eval code/g, '(')\n    .replace(/^.*?\\s+/, '')\n\n  // capture and preserve the parenthesized location \"(/foo/my bar.js:12:87)\" in\n  // case it has spaces in it, as the string is split on \\s+ later on\n  const location = sanitizedLine.match(/ (\\(.+\\)$)/)\n\n  // remove the parenthesized location from the line, if it was matched\n  sanitizedLine = location\n    ? sanitizedLine.replace(location[0], '')\n    : sanitizedLine\n\n  // if a location was matched, pass it to extractLocation() otherwise pass all sanitizedLine\n  // because this line doesn't have function name\n  const [url, lineNumber, columnNumber] = extractLocation(\n    location ? location[1]! : sanitizedLine\n  )\n  let method = (location && sanitizedLine) || ''\n  let file = url && ['eval', '<anonymous>'].includes(url) ? undefined : url\n\n  if (!file || !lineNumber || !columnNumber) return null\n\n  if (method.startsWith('async ')) method = method.slice(6)\n\n  if (file.startsWith('file://')) file = file.slice(7)\n\n  // normalize Windows path (\\ -> /)\n  file = resolve(file)\n\n  return {\n    method,\n    file,\n    line: parseInt(lineNumber),\n    column: parseInt(columnNumber)\n  }\n}\n\nexport const parseStacktrace = (\n  stackStr: string,\n  full = false\n): ParsedStack[] => {\n  const stackFrames = stackStr\n    .split('\\n')\n    .map((raw): ParsedStack | null => {\n      const stack = parseSingleStack(raw)\n\n      if (\n        !stack ||\n        (!full && stackIgnorePatterns.some(p => stack.file.match(p)))\n      )\n        return null\n\n      return stack\n    })\n    .filter(notNullish)\n\n  return stackFrames\n}\n","import type { ParsedStack } from 'vitest'\n\nconst repository = process.env.GITHUB_WORKSPACE\nconst repositoryPrefixes = repository ? [repository.replace(/\\/?$/, '/')] : []\n\nexport const stringifyStacktrace = (\n  stack: ParsedStack[],\n  trimRepositoryPrefix: boolean\n) => {\n  return stack\n    .map(s => {\n      let file = s.file\n      if (trimRepositoryPrefix && repositoryPrefixes.length > 0) {\n        file = trimPrefixes(file, repositoryPrefixes)\n      }\n\n      return `  at ${s.method ? `${s.method} ` : ''}${file}:${s.line}:${\n        s.column\n      }`\n    })\n    .join('\\n')\n}\n\nconst trimPrefixes = (str: string, prefixes: string[]) => {\n  for (const p of prefixes) {\n    if (str.startsWith(p)) {\n      str = str.slice(p.length)\n      break\n    }\n  }\n  return str\n}\n"],"mappings":";AAQA;AAAA,EACE;AAAA,EACA;AAAA,EACA;AAAA,OAEK;;;ACJP,OAAO,UAAU;AAEjB,IAAM,sBAAsB;AAAA,EAC1B;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEA,IAAM,QAAQ,CAAC,QAAgB,IAAI,QAAQ,OAAO,GAAG;AACrD,IAAM,UAAU,CAAC,QAAgB,MAAM,KAAK,QAAQ,GAAG,CAAC;AAExD,SAAS,WAAc,GAA8C;AACnE,SAAO,KAAK;AACd;AAEA,SAAS,gBAAgB,SAAiB;AAExC,MAAI,CAAC,QAAQ,SAAS,GAAG;AAAG,WAAO,CAAC,OAAO;AAE3C,QAAM,SAAS;AACf,QAAM,QAAQ,OAAO,KAAK,QAAQ,QAAQ,SAAS,EAAE,CAAC;AACtD,MAAI,CAAC;AAAO,WAAO,CAAC,OAAO;AAC3B,SAAO,CAAC,MAAM,CAAC,GAAG,MAAM,CAAC,KAAK,QAAW,MAAM,CAAC,KAAK,MAAS;AAChE;AAIO,SAAS,iBAAiB,KAAiC;AAChE,MAAI,OAAO,IAAI,KAAK;AAEpB,MAAI,KAAK,SAAS,QAAQ;AACxB,WAAO,KACJ,QAAQ,cAAc,MAAM,EAC5B,QAAQ,8BAA8B,EAAE;AAE7C,MAAI,gBAAgB,KACjB,QAAQ,QAAQ,EAAE,EAClB,QAAQ,gBAAgB,GAAG,EAC3B,QAAQ,WAAW,EAAE;AAIxB,QAAM,WAAW,cAAc,MAAM,YAAY;AAGjD,kBAAgB,WACZ,cAAc,QAAQ,SAAS,CAAC,GAAG,EAAE,IACrC;AAIJ,QAAM,CAAC,KAAK,YAAY,YAAY,IAAI;AAAA,IACtC,WAAW,SAAS,CAAC,IAAK;AAAA,EAC5B;AACA,MAAI,SAAU,YAAY,iBAAkB;AAC5C,MAAI,OAAO,OAAO,CAAC,QAAQ,aAAa,EAAE,SAAS,GAAG,IAAI,SAAY;AAEtE,MAAI,CAAC,QAAQ,CAAC,cAAc,CAAC;AAAc,WAAO;AAElD,MAAI,OAAO,WAAW,QAAQ;AAAG,aAAS,OAAO,MAAM,CAAC;AAExD,MAAI,KAAK,WAAW,SAAS;AAAG,WAAO,KAAK,MAAM,CAAC;AAGnD,SAAO,QAAQ,IAAI;AAEnB,SAAO;AAAA,IACL;AAAA,IACA;AAAA,IACA,MAAM,SAAS,UAAU;AAAA,IACzB,QAAQ,SAAS,YAAY;AAAA,EAC/B;AACF;AAEO,IAAM,kBAAkB,CAC7B,UACA,OAAO,UACW;AAClB,QAAM,cAAc,SACjB,MAAM,IAAI,EACV,IAAI,CAAC,QAA4B;AAChC,UAAM,QAAQ,iBAAiB,GAAG;AAElC,QACE,CAAC,SACA,CAAC,QAAQ,oBAAoB,KAAK,OAAK,MAAM,KAAK,MAAM,CAAC,CAAC;AAE3D,aAAO;AAET,WAAO;AAAA,EACT,CAAC,EACA,OAAO,UAAU;AAEpB,SAAO;AACT;;;AC5GA,IAAM,aAAa,QAAQ,IAAI;AAC/B,IAAM,qBAAqB,aAAa,CAAC,WAAW,QAAQ,QAAQ,GAAG,CAAC,IAAI,CAAC;AAEtE,IAAM,sBAAsB,CACjC,OACA,yBACG;AACH,SAAO,MACJ,IAAI,OAAK;AACR,QAAI,OAAO,EAAE;AACb,QAAI,wBAAwB,mBAAmB,SAAS,GAAG;AACzD,aAAO,aAAa,MAAM,kBAAkB;AAAA,IAC9C;AAEA,WAAO,QAAQ,EAAE,SAAS,GAAG,EAAE,MAAM,MAAM,EAAE,GAAG,IAAI,IAAI,EAAE,IAAI,IAC5D,EAAE,MACJ;AAAA,EACF,CAAC,EACA,KAAK,IAAI;AACd;AAEA,IAAM,eAAe,CAAC,KAAa,aAAuB;AACxD,aAAW,KAAK,UAAU;AACxB,QAAI,IAAI,WAAW,CAAC,GAAG;AACrB,YAAM,IAAI,MAAM,EAAE,MAAM;AACxB;AAAA,IACF;AAAA,EACF;AACA,SAAO;AACT;;;AFHA,IAAqB,wBAArB,MAA+D;AAAA,EAC7D;AAAA,EACA;AAAA,EAEA,YAAY;AAAA,IACV,uBAAuB;AAAA,IACvB,iBAAiB;AAAA,EACnB,IAAkC,CAAC,GAAG;AACpC,SAAK,UAAU;AAAA,MACb;AAAA,MACA;AAAA,IACF;AAAA,EACF;AAAA,EAEA,OAAO,KAAa;AAClB,SAAK,MAAM;AAAA,EACb;AAAA,EAEA,MAAM,WAAW,OAAgB;AAC/B,QAAI,CAAC;AAAO;AAEZ,eAAW,oBAAoB;AAC/B,SAAK,YAAY,KAAK;AACtB,aAAS;AAAA,EACX;AAAA,EAEQ,YAAY,OAAe;AACjC,eAAW,QAAQ,OAAO;AACxB,WAAK,iBAAiB,KAAK,UAAU,IAAI;AACzC,WAAK,YAAY,KAAK,UAAU,KAAK,KAAK;AAAA,IAC5C;AAAA,EACF;AAAA,EAEQ,YAAY,UAAkB,OAAe;AACnD,eAAW,QAAQ,OAAO;AACxB,UAAI,KAAK,SAAS,SAAS;AACzB,aAAK,iBAAiB,UAAU,IAAI;AAEpC,aAAK,YAAY,UAAU,KAAK,KAAK;AAAA,MACvC,WAAW,KAAK,SAAS,QAAQ;AAC/B,aAAK,iBAAiB,UAAU,IAAI;AAAA,MACtC,WAAW,KAAK,SAAS,UAAU;AAAA,MAEnC,OAAO;AACL,mBAAW,IAAI;AAAA,MACjB;AAAA,IACF;AAAA,EACF;AAAA,EAEQ,iBAAiB,UAAkB,MAAY;AA7EzD;AA8EI,eAAW,SAAO,UAAK,WAAL,mBAAa,WAAU,CAAC,GAAG;AAC3C,WAAK,gBAAgB,KAAK,MAAM,UAAU,GAAG;AAAA,IAC/C;AAAA,EACF;AAAA,EAEQ,gBACN,UACA,UACA,KACA;AACA,UAAM,aAAa,KAAK,gBAAgB,IAAI,QAAQ;AACpD,UAAM,WAAW,KAAK,qBAAqB,UAAU,UAAU;AAC/D,UAAM,UAAU,KAAK,cAAc,UAAU;AAE7C,UAAM,SAAS;AAAA,MACb,GAAG;AAAA,MACH,OAAO,KAAK;AAAA,QACV;AAAA,QACA,UAAU,SAAS,CAAC,EAAG,YAAY,CAAC,GAAG,SAAS,MAAM,CAAC,CAAC;AAAA,MAC1D;AAAA,IACF,CAAC;AAAA,EACH;AAAA,EAEQ,gBAAgB,eAAmC;AACzD,QAAI,CAAC;AAAe,aAAO;AAC3B,WAAO,gBAAgB,aAAa;AAAA,EACtC;AAAA,EAEQ,cAAc,YAAuC;AAC3D,QAAI,KAAK,QAAQ;AAAgB,aAAO;AAExC,QAAI,CAAC;AAAY,aAAO;AACxB,WAAO,oBAAoB,YAAY,KAAK,QAAQ,oBAAoB;AAAA,EAC1E;AAAA,EAEQ,qBACN,UACA,YACsB;AACtB,QAAI,CAAC,cAAc,CAAC,WAAW,CAAC,GAAG;AACjC,aAAO,EAAE,MAAM,SAAS;AAAA,IAC1B;AAEA,UAAM,EAAE,MAAM,MAAM,OAAO,IAAI,WAAW,CAAC;AAC3C,WAAO;AAAA,MACL;AAAA,MACA,WAAW;AAAA,MACX,aAAa;AAAA,IACf;AAAA,EACF;AAAA,EAEQ,cAAcA,QAAkC,UAAkB;AACxE,WAAO,IAAGA,UAAA,gBAAAA,OAAO,SAAQ,OAAO,MAAKA,UAAA,gBAAAA,OAAO,YAAW,QAAQ;AAAA,EACjE;AACF;AAGA,SAAS,WAAW,GAAU;AAAC;","names":["error"]}